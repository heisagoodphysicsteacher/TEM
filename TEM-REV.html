<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEM Lab (PLKCHC)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        canvas { background: #020617; border-radius: 24px; border: 2px solid #1e293b; width: 100%; height: 400px; cursor: help; }
        .math-card { background: rgba(15, 23, 42, 0.95); border: 1px solid #334155; }
        .sub-box { background: #000; padding: 10px; border-radius: 8px; font-family: 'Segoe UI', sans-serif; border-left: 4px solid #0ea5e9; line-height: 1.5; }
        .val-highlight { font-weight: bold; font-family: monospace; }
        .screen-view { background: radial-gradient(circle, #065f46 0%, #000 100%); border: 6px solid #334155; }
        /* 提示框樣式 */
        #tooltip { pointer-events: none; position: absolute; z-index: 100; transform: translate(-50%, -120%); transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-4 md:p-8 font-sans">

    <header class="max-w-[1200px] mx-auto mb-6 text-center">
        <h1 class="text-3xl md:text-5xl font-black text-cyan-400">Transmission Electron Microscope (PLKCHC)</h1>
    </header>

    <main class="max-w-[1200px] mx-auto space-y-6">
        
        <div class="bg-slate-900 p-4 rounded-3xl border border-slate-800 relative overflow-hidden">
            <canvas id="temCanvas"></canvas>
            <div id="tooltip" class="opacity-0 bg-slate-800 border-2 border-cyan-500 p-4 rounded-xl shadow-2xl max-w-xs text-xs">
                <h3 id="tip-title" class="text-cyan-400 font-bold mb-1 uppercase text-base border-b border-cyan-900"></h3>
                <p id="tip-desc" class="text-slate-300 mt-2 italic"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="math-card p-6 rounded-2xl">
                <h4 class="text-blue-400 font-black text-xs mb-3 uppercase">1. Momentum (p)</h4>
                <div class="text-lg mb-4 text-center">$$p = \sqrt{2mqV}$$</div>
                <div class="sub-box text-[11px]">
                    <span class="text-slate-400 italic">Substitution:</span><br>
                    &radic;( 2 &times; 9.11&times;10<sup>-31</sup> &times; 1.6&times;10<sup>-19</sup> &times; <span id="subV" class="text-blue-400 val-highlight">---</span> )
                </div>
                <div id="resP" class="mt-4 text-xl font-mono font-black text-blue-400 text-right">---</div>
            </div>

            <div class="math-card p-6 rounded-2xl">
                <h4 class="text-purple-400 font-black text-xs mb-3 uppercase">2. Wavelength (\(\lambda\))</h4>
                <div class="text-lg mb-4 text-center">$$\lambda = \frac{h}{p}$$</div>
                <div class="sub-box text-[11px]">
                    <span class="text-slate-400 italic">Substitution:</span><br>
                    6.63&times;10<sup>-34</sup> &divide; ( <span id="subP" class="text-purple-400 val-highlight">---</span> )
                </div>
                <div id="resL" class="mt-4 text-xl font-mono font-black text-purple-400 text-right">---</div>
            </div>

            <div class="math-card p-6 rounded-2xl">
                <h4 class="text-green-400 font-black text-xs mb-3 uppercase">3. Resolution (s)</h4>
                <div class="text-lg mb-4 text-center">$$s = 1.22 \lambda r/ D $$</div>
                <div class="sub-box text-[11px]">
                    <span class="text-slate-400 italic">Substitution:</span><br>
                    1.22 &times; ( <span id="subL" class="text-green-400 val-highlight">---</span> )
                </div>
                <div id="resS" class="mt-4 text-2xl font-mono font-black text-green-400 text-right">---</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center bg-slate-900/50 p-6 rounded-3xl border border-slate-800">
            <div class="flex flex-col items-center">
                <div class="w-48 h-48 rounded-full screen-view flex items-center justify-center overflow-hidden shadow-2xl">
                    <div id="atomGrid" class="grid grid-cols-6 gap-4 transition-all duration-700 opacity-10"></div>
                </div>
                <div class="text-[10px] text-slate-500 mt-2 uppercase font-bold tracking-widest">Fluorescent Screen Output</div>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-end">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Accelerating Voltage (V)</label>
                        <div id="vDisplay" class="text-4xl font-mono text-cyan-400 font-black">10,000 V</div>
                    </div>
                    <button id="powerBtn" class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-black rounded-xl uppercase transition-all active:scale-95">Fire Gun</button>
                </div>
                <input type="range" id="vSlider" min="5000" max="100000" step="5000" value="10000" class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>
        </div>

        <footer class="text-center py-6 border-t border-slate-800">
            <p id="finalConclusion" class="text-slate-300 text-lg">
                Resolution of TEM is about 10^-11 m, which is much higher than a Optical Microscope (10^-7 m).
            </p>
        </footer>
    </main>

    <script>
        const canvas = document.getElementById('temCanvas');
        const ctx = canvas.getContext('2d');
        const vSlider = document.getElementById('vSlider');
        const vDisplay = document.getElementById('vDisplay');
        const powerBtn = document.getElementById('powerBtn');
        const atomGrid = document.getElementById('atomGrid');
        const finalConclusion = document.getElementById('finalConclusion');
        const tooltip = document.getElementById('tooltip');
        const tipTitle = document.getElementById('tip-title');
        const tipDesc = document.getElementById('tip-desc');

        const h = 6.626e-34, m = 9.11e-31, q = 1.602e-19;
        let isActive = false, particles = [];

        // 補回組件描述數據
        const comps = [
            {n: "Electron Gun", x: 0.05, w: 0.1, d: "Cathode filament that emits electrons through thermionic emission."},
            {n: "Anode (+V)", x: 0.18, w: 0.03, d: "Positively charged plate that accelerates electrons to high velocity."},
            {n: "Condenser", x: 0.30, w: 0.06, d: "Electromagnetic lenses that focus the electron beam into a parallel path."},
            {n: "Specimen", x: 0.46, w: 0.015, d: "The ultra-thin sample being imaged. Electrons pass through it."},
            {n: "Objective", x: 0.62, w: 0.08, d: "Magnetic lens that determines the initial resolution and magnification."},
            {n: "Projection", x: 0.80, w: 0.08, d: "Final stage lenses that expand the image onto the detector screen."},
            {n: "Screen", x: 0.95, w: 0.02, d: "Phosphor-coated screen that glows green when hit by electrons, making the image visible."}
        ];

        function formatHTMLScientific(num) {
            let parts = num.toExponential(2).split('e');
            return `${parts[0]} &times; 10<sup>${parts[1].replace('+', '')}</sup>`;
        }

        for(let i=0; i<36; i++) {
            const div = document.createElement('div');
            div.className = "w-2.5 h-2.5 bg-green-400 rounded-full shadow-[0_0_8px_#4ade80]";
            atomGrid.appendChild(div);
        }

        function updatePhysics() {
            const V = parseFloat(vSlider.value);
            const p = Math.sqrt(2 * m * q * V);
            const lambda = h / p;
            const s = 1.22 * lambda;
            const s_nm = s * 1e9;

            vDisplay.innerText = V.toLocaleString() + " V";
            document.getElementById('subV').innerHTML = V.toLocaleString();
            document.getElementById('subP').innerHTML = formatHTMLScientific(p);
            document.getElementById('subL').innerHTML = formatHTMLScientific(lambda);

            document.getElementById('resP').innerText = p.toExponential(3) + " kg·m/s";
            document.getElementById('resL').innerText = lambda.toExponential(3) + " m";
            document.getElementById('resS').innerText = s_nm.toFixed(5) + " nm";

            finalConclusion.innerHTML = `Resolution of TEM (10^-11 m to 10^-12 m) is much higher than a Optical Microscope (10^-7 m).`;
            if(window.MathJax) MathJax.typesetPromise([finalConclusion]);

            atomGrid.style.filter = isActive ? `blur(${Math.max(0, (s * 1e11) - 0.2)}px)` : `blur(20px)`;
            atomGrid.style.opacity = isActive ? 1 : 0.1;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const W = canvas.width, H = canvas.height, midY = H/2;

            ctx.setLineDash([5, 5]); ctx.strokeStyle = "#334155";
            ctx.strokeRect(0.02*W, midY - 60, 0.22*W, 120);
            ctx.setLineDash([]);

            comps.forEach(c => {
                const drawX = c.x * W, drawW = c.w * W;
                const drawH = c.n.includes("Lens") || ["Objective", "Projection", "Condenser"].includes(c.n) ? H * 0.45 : (c.n === "Specimen" ? 40 : H * 0.7);
                const drawY = midY - drawH/2;
                
                if(c.n.includes("Gun")) {
                    ctx.beginPath(); ctx.strokeStyle = isActive ? "#fbbf24" : "#475569"; ctx.lineWidth = 3;
                    ctx.moveTo(drawX, midY-15); ctx.lineTo(drawX+drawW, midY); ctx.lineTo(drawX, midY+15); ctx.stroke();
                } else {
                    ctx.fillStyle = (c.n === "Screen" && isActive) ? "#059669" : "#1e293b";
                    ctx.strokeStyle = "#475569"; ctx.lineWidth = 2;
                    ctx.fillRect(drawX, drawY, drawW, drawH); ctx.strokeRect(drawX, drawY, drawW, drawH);
                }
                ctx.fillStyle = "#64748b"; ctx.font = `bold ${W < 600 ? 9 : 11}px Arial`; ctx.textAlign = "center";
                ctx.fillText(c.n, drawX + drawW/2, drawY + drawH + 20);
            });

            if(isActive) {
                if(Math.random() > 0.1) particles.push({x: 0.15*W, y: midY + (Math.random()-0.5)*10, v: (W*0.008)*(vSlider.value/20000)});
                particles.forEach((p, i) => {
                    p.x += p.v;
                    if(p.x > 0.3*W && p.x < 0.46*W) p.y += (midY - p.y) * 0.05;
                    if(p.x > 0.62*W && p.x < 0.8*W) p.y += (midY - p.y) * 0.1;
                    if(p.x >= 0.95*W) {
                        ctx.fillStyle = "#4ade80"; ctx.beginPath(); ctx.arc(0.95*W, p.y, 5, 0, 7); ctx.fill();
                        particles.splice(i, 1);
                    } else {
                        ctx.fillStyle = "#22d3ee"; ctx.beginPath(); ctx.arc(p.x, p.y, 1.5, 0, 7); ctx.fill();
                    }
                });
            }
            requestAnimationFrame(draw);
        }

        // 補回滑鼠偵測邏輯
        const handleMove = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const clientY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            // 換算成 canvas 內部的坐標
            const mx = clientX * (canvas.width / rect.width);
            
            let hit = false;
            comps.forEach(c => {
                const drawX = c.x * canvas.width;
                const drawW = c.w * canvas.width;
                // 檢查滑鼠是否在該組件的 X 軸範圍內
                if(mx > drawX && mx < drawX + drawW) {
                    tooltip.style.opacity = 1; 
                    tooltip.style.left = (e.touches ? e.touches[0].clientX : e.clientX) + "px";
                    tooltip.style.top = (e.touches ? e.touches[0].clientY : e.clientY) + "px";
                    tipTitle.innerText = c.n;
                    tipDesc.innerText = c.d;
                    hit = true;
                }
            });
            if(!hit) tooltip.style.opacity = 0;
        };

        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchstart', (e) => { handleMove(e); e.preventDefault(); });

        powerBtn.onclick = () => { isActive = !isActive; powerBtn.innerText = isActive ? "Stop" : "Fire Gun"; powerBtn.className = isActive ? "px-8 py-3 bg-red-600 text-white font-black rounded-xl uppercase" : "px-8 py-3 bg-cyan-600 text-white font-black rounded-xl uppercase"; updatePhysics(); };
        window.onresize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; };
        vSlider.oninput = updatePhysics;
        window.onload = () => { window.onresize(); updatePhysics(); draw(); };
    </script>
</body>

</html>





